"""
MCP Tool: transcript_stats

ì´ ëª¨ë“ˆì€ MCP í´ë¼ì´ì–¸íŠ¸(ì˜ˆ: Claude Desktop)ê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” "ìë§‰ í†µê³„" ë„êµ¬ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
í•µì‹¬ êµ¬ì„± ìš”ì†ŒëŠ” ë‘ ê°€ì§€ì…ë‹ˆë‹¤:
  1) tool_spec: LLMì´ ì°¸ê³ í•˜ëŠ” ë„êµ¬ì˜ "ë©”ë‰´íŒ"(ì´ë¦„/ì„¤ëª…/ì…ë ¥ ìŠ¤í‚¤ë§ˆ)
  2) handle(): LLMì´ call_toolë¡œ ì´ ë„êµ¬ë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ ì‹¤ì œë¡œ ì‹¤í–‰ë˜ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜

íë¦„ ê°œìš”
---------
- LLMì€ ë¨¼ì € ì„œë²„ì˜ list_tools()ë¡œ tool_spec ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
- ì‚¬ìš©ìì˜ ìš”ì²­ì„ ë³´ê³  ì´ ë„êµ¬ê°€ ì í•©í•˜ë‹¤ê³  íŒë‹¨ë˜ë©´, inputSchemaì— ë§ì¶”ì–´ argumentsë¥¼ êµ¬ì„±í•œ ë’¤
  call_tool(name="transcript_stats", arguments={...}) ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.
- handle()ëŠ” URLì—ì„œ ë¹„ë””ì˜¤ IDë¥¼ ì¶”ì¶œí•˜ê³ , ìë§‰ì„ ë¶ˆëŸ¬ì™€ ê¸¸ì´/ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜ ë“± í†µê³„ë¥¼ ê³„ì‚°í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.

ì°¸ê³ 
----
- ìë§‰ ë¡œë”©ì€ utils.youtube.fetch_transcript_flexible()ê°€ ìˆ˜í–‰í•©ë‹ˆë‹¤.
  ì´ í—¬í¼ëŠ” ì–¸ì–´ í›„ë³´ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹œë„í•˜ê³ (dict/ê°ì²´ ë°˜í™˜ ì°¨ì´ë„ í¡ìˆ˜) full_text/ê¸¸ì´ê¹Œì§€ ê³„ì‚°í•©ë‹ˆë‹¤.
"""

from typing import List, Dict, Any

# MCP í‘œì¤€ íƒ€ì…: Tool(ë„êµ¬ ë©”íƒ€ë°ì´í„°), TextContent(í…ìŠ¤íŠ¸ ì‘ë‹µ ì½˜í…ì¸ )
from mcp.types import Tool, TextContent

# ë‚´ë¶€ ìœ í‹¸: URLì—ì„œ ë¹„ë””ì˜¤ ID ì¶”ì¶œ, ìë§‰ ìœ ì—° ë¡œë”©/ì •ê·œí™”
from utils.youtube import extract_video_id, fetch_transcript_flexible

# ---------------------------------------------------------------------------
# tool_spec: LLMì— ë…¸ì¶œë˜ëŠ” ë„êµ¬ì˜ "ë©”ë‰´íŒ" ì •ì˜
# - name/description: ë„êµ¬ ì„ íƒì„ ë•ëŠ” í•µì‹¬ ì •ë³´
# - inputSchema: JSON Schemaë¡œ ì…ë ¥ íŒŒë¼ë¯¸í„° ê·œì • (ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ url/languageë§Œ ì‚¬ìš©)
#   * required: ["url"] ë¡œ URLì€ ë°˜ë“œì‹œ í•„ìš”í•¨ì„ ëª…ì‹œ
#   * ë³´ë‹¤ ê°•í•œ ì œì•½/ì˜ˆì‹œê°€ í•„ìš”í•˜ë©´ summarize_youtubeì˜ ìŠ¤í‚¤ë§ˆì²˜ëŸ¼ í™•ì¥ ê°€ëŠ¥
# ---------------------------------------------------------------------------
tool_spec = Tool(
    name="transcript_stats",
    description="YouTube ìë§‰ì˜ í†µê³„ ì •ë³´ë§Œ ë°˜í™˜",
    inputSchema={
        "type": "object",
        "properties": {
            "url": {"type": "string"},           # ë¶„ì„ ëŒ€ìƒ ë¹„ë””ì˜¤ URL
            "language": {"type": "string"},      # ì„ íƒ: ìë§‰ ì–¸ì–´ ì½”ë“œ(ko, en, ja, en-US ë“±)
        },
        "required": ["url"],
    },
)


# ---------------------------------------------------------------------------
# handle(): LLMì´ call_tool("transcript_stats", arguments)ë¡œ ì´ ë„êµ¬ë¥¼ ì‹¤í–‰í•  ë•Œ í˜¸ì¶œ
# ì²˜ë¦¬ ìˆœì„œ
#  1) ì…ë ¥ ì •ë¦¬ â†’ 2) ë¹„ë””ì˜¤ ID ì¶”ì¶œ â†’ 3) ìë§‰ ë¡œë”© â†’ 4) í†µê³„ ë©”ì‹œì§€ êµ¬ì„±
# ë°˜í™˜ì€ MCP ì½˜í…ì¸  íŒŒíŠ¸(List[TextContent]) í˜•ì‹
# ---------------------------------------------------------------------------
async def handle(arguments: Dict[str, Any]) -> List[TextContent]:
    # 1) ì…ë ¥ ì •ë¦¬ -------------------------------------------------------------
    url = arguments.get("url")
    language = arguments.get("language")

    # 2) ë¹„ë””ì˜¤ ID ì¶”ì¶œ --------------------------------------------------------
    vid = extract_video_id(url)
    if not vid:
        return [TextContent(type="text", text="âŒ ìœ íš¨í•œ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤.")]

    # 3) ìë§‰ ë¡œë”© --------------------------------------------------------------
    # ì–¸ì–´ê°€ ì§€ì •ë˜ë©´ í•´ë‹¹ ì–¸ì–´ â†’ ìë™ìƒì„± í›„ë³´ â†’ ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ í›„ë³´/ê¸°ë³¸ ì–¸ì–´ ìˆœìœ¼ë¡œ ì‹œë„
    data, lang_used, duration_str, full_text = await fetch_transcript_flexible(vid, language)
    if not data:
        return [TextContent(type="text", text="âŒ ìë§‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")]

    # 4) í†µê³„ ë©”ì‹œì§€ êµ¬ì„± -------------------------------------------------------
    # - lang_used: ì‹¤ì œë¡œ ì„ íƒëœ ìë§‰ ì–¸ì–´(ë˜ëŠ” ì•Œ ìˆ˜ ì—†ìŒ)
    # - len(data): ì„¸ê·¸ë¨¼íŠ¸ ê°œìˆ˜
    # - len(full_text): ì „ì²´ í…ìŠ¤íŠ¸ ê¸¸ì´(ë¬¸ì ìˆ˜)
    # - duration_str: ë§ˆì§€ë§‰ ì„¸ê·¸ë¨¼íŠ¸ì˜ start+durationìœ¼ë¡œ ì¶”ì •í•œ ê¸¸ì´(ë¶„/ì´ˆ)
    msg = (
        f"ğŸ“Š í†µê³„\n"
        f"- ì–¸ì–´: {lang_used or 'ì•Œ ìˆ˜ ì—†ìŒ'}\n"
        f"- ì„¸ê·¸ë¨¼íŠ¸: {len(data)}\n"
        f"- ë³¸ë¬¸ ê¸¸ì´: {len(full_text)}ì\n"
        f"- ì¶”ì • ê¸¸ì´: {duration_str}\n"
    )
    return [TextContent(type="text", text=msg)]